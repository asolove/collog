<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
        "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"> 
  <head>
    <title>scripty2 demo | Flickr Touchshow</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <script src="prototype.s2.min.js" type="text/javascript"></script>
    
    <style type="text/css" media="screen">
      body { 
        font: 12px/15px "Palatino Linotype", "Book Antiqua", "Palatino", serif; 
        margin: 0; 
        background:#333; 
        overflow:hidden;
      }
      #my-collages {
		}
	  #inspiration { 
		margin-left:550px;
		}
	  .collage {
		position:absolute;
        margin:15px;
        width: 500px;
        height: 500px;
        background:#222;
        overflow: hidden;
        -webkit-box-shadow: 0px 0px 20px rgba(0,0,0,0.7); 
        -webkit-border-bottom-right-radius:10px;
        border:1px solid rgba(255,255,255,0.2);
      }
      input {
        font-size: 18px;
		background-color: #111;
		border:1px solid #000;
		color:#fff;
        width: 180px;
      }
      .photos img {
        position: absolute;
        left: 864px;
        top: 0px;
        z-index: 0;
        -webkit-box-shadow: 2px 2px 10px rgba(0,0,0,0.7);
        border:1px solid rgba(255,255,255,0.3);
      }
      form {
        z-index:1000;
      }
      .clear {
        margin: 3px;
        padding: 2px 10px;
        font-size: 14px;
        background: #800;
        color: #fff;
        cursor: pointer;
      }
      .fetch {
        margin: 3px;
        padding: 2px 10px;
        font-size: 14px;
        background: rgba(0,80,0,0.5);
        color: #fff;
        cursor: pointer;
      }
      .header {
        position:absolute; 
        top:0px;
        width: 864px;
        padding:0px 10px;
        background: rgba(0,0,0,0.3);
        -webkit-box-shadow: 1px 0px 5px rgba(0,0,0,0.3);
        z-index: 99999999;
      }
      .header.loading {
        background-image: url(loading.gif);
        background-repeat: no-repeat;
        background-position: center center;
      }
      .info {
        position: absolute;
        bottom:0px;
        padding: 5px;
        background: rgba(0,0,0,0.3);
        color: #fff;
        font-size: 12px;
        height: 16px;
        width:100%;
      }
      .info a {
        color: #fff;
        text-decoration: none;
      }
      #logo {
        width:4em;
        text-align:center;
        margin-left:15px;
        padding:2px;
        font-size:14px;
        font-family:"Arial";
        background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#cc9900), to(#fe6));
        -webkit-box-shadow: 0px 0px 20px rgba(0,0,0,0.7);
        color:#000;
      }
    </style>
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
  </head>   
  <body>
	
    <div id="logo">collog</div>
    <div id="debug"></div>

    <div id="my-collages">
      <div class="collage">
      	<div class="header">
      	  <form onsubmit="processForm();return false">
      	    <input type="text" name="q" class="q" value="Summer" /> 
      	    <span class="fetch" onclick="processForm()">Save</span>
      	  </form>
      	</div>
      
      	<div class="photos"></div>
      	
      	<div class="info">Touch an image to select and manipulate.</div>
	  </div>	
    </div>

	<div id="inspiration">
      <div class="collage">
      	<div class="header">
      	  <form onsubmit="processForm();return false">
      	    <input type="text" name="q" class="q" value="Summer" /> 
      	    <span class="fetch" onclick="processForm()">Grab from flickr!</span>
      	    <span class="clear">clear</span>
      	  </form>
      	</div>
      
      	<div class="photos"></div>
      	
      	<div class="info">Touch an image to select and manipulate.</div>
	  </div>
	</div>

    <script type="text/javascript">
      S2.enableMultitouchSupport = true;
    
      (function(exp){
        var r = Math.random,
			      subElement = function(sel) {
			      	return function(self) {
			      		return Selector.findElement(self, sel);
			      	};
			      },
			      subElements = function(sel) {
			      	return function(self) {
			      		return Selector.findChildElements(self, sel);
			      	};
			      },
			      Collage = Object.extend(Element, {
			      	photoE:  subElement(".photos"),
			      	imageEs: subElements(".photos img"),
			      	headerE: subElement(".header"),
			      	clearE:  subElement(".clear"),
			      	infoE:   subElement(".info"),
			      	newImage: function(self, img) {
			      	  var image = new Element('img', { src: img.photo.media.m }), 
                  x=img.x, y=img.y, z=img.z, t=img["-webkit-transform"], pos=[x,y,]
                image.style.cssText += ";top:"+y+";left:"+x+";z-index:"+z+";-webkit-transform:"+t;
                return image;
			      	},
			      	insertImage: function(self, img) {
                self.photoE().insert(image);
			      	},
			      	initialize: function(self, data) {
	              data.images.each(function(img) {
	                self.insertImage(self.newImage(img));
	              });
			      	}
			      }),
			      
			      EditableCollage = Object.extend(Collage, {
			        addEvents: function(self, img) {
			          
			        },
			        newImage: function(self, img) {
			          super(img);
			          return self.addEvents(img);
			        }
			        serialize: function(self) {
  		      		return {
  		      	    name: "My collage",
  		      	    images: $$('#photos img').map(function(img){
  		      	              return { 
  		      	                photo: img.photo,
  		      	                x: img.style.left,
  		      	                y: img.style.top,
  		      	                z: img.style.zIndex,
  		      	                "-webkit-transform": img.style["-webkit-transform"]
  		      	              };
  		      	            })
  		      	  };
			        }
			      });
			
			
			
			
			
        
        function processForm(){
          var url = 'http://api.flickr.com/services/feeds/'+
            'photos_public.gne?format=json&tags='+
            encodeURIComponent($('q').getValue())+
            '&tags_mode=ANY';
          $(document.body).insert(new Element('script',{ src: url, type: 'text/javascript' }));
          $('header').addClassName('loading');
        }
        
        var FRICTION = 5, z = 0, lastPhoto;
        function addEvents(img, pos){
          img.observe('manipulate:update', function(event){
            img.style.cssText += 
              ';z-index:'+(z++)+';left:'+(pos[0]+event.memo.panX)+'px;top:'+(pos[1]+event.memo.panY)+'px;';
            img.transform({ rotation: pos[2]+event.memo.rotation, scale: event.memo.scale });
            img._x = pos[0]+event.memo.panX;
            img._y = pos[1]+event.memo.panY;
            event.stop();
                        // 
                        // if(!lastPhoto || !(lastPhoto==img)){
                        //   lastPhoto = img;
                        //   $('info').innerHTML =
                        //     '<a href="'+pos[3].link+'">'+
                        //     '<b>“'+pos[3].title.escapeHTML()+'”</b> by '+
                        //     '<b>'+pos[3].author.gsub(/^(.*)\(/,'').gsub(/\)$/,'').escapeHTML()+'</b></a>';
                        // }
          });
        }
        
        function processData(data){
          data.items.sortBy(r).each(function(photo,idx){
            if(idx>5) return;
            var image = new Element('img', { src: photo.media.m }),
              pos = [r()*750, r()*150, r()*1-0.5, photo];
            $('photos').insert(image);
            image.style.cssText += ';top:'+((r()*700)-300)+'px;z-index:'+(z++);
            image.transform({ rotation: pos[2] });
            image.photo = photo;
            image.morph(
              'left:'+pos[0]+'px;'+
              'top:'+pos[1]+'px',{
                duration:0.2+r()*1.5,delay:idx*0.2
            });
            addEvents(image, pos);
          });
          $('header').removeClassName('loading');
        }
        $('clear').observe('click', function(){
          $$('#photos img').each(function(photo){
            photo.morph('left:-500px;top:'+(r()*600)+'px',{ duration: 0.3,
              after: function(){ Element.remove(photo); } });
          });
        });
        exp['processForm'] = processForm;
        exp['jsonFlickrFeed'] = processData;
        exp['serialize'] = serialize;
        exp['deserialize'] = deserialize;
        
        $('q').focus();
      })(window);
    </script>
    
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">try{var pageTracker=_gat._getTracker("UA-2732152-10");pageTracker._trackPageview();}catch(err){}</script>
  </body>
</html>