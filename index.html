<html>
<head>
<title></title>
<style>
body { font: 12px/1.2 Arial, serif; background-color:#e8e8e0;}

.collage { 
  float:left; margin-right:10px;
  position:relative; width: 400px; height:500px; border:1px solid #887;             
  background-color:#f8f8f0;}
  
.header { z-index:1000; position:absolute;background-color: rgba(0,0,0,0.2); width:100%; height:25px;}

.collage .photos {
  position:relative; top:0px; left:0px;
  width:400px; height:500px;
  overflow:hidden;
}

.collage img { position: absolute; width:25%; }
</style>
</head>
<body>
  <div class="collage" id="flickr_collage">
    <div class="header">
      <form>
        <input type="text" name="q" class="q" value="Search flickr" /> 
        <input type="submit" value="Go!" class="fetch"/>
      </form>
    </div>
    <div class="photos"></div>
  </div>
  
  
  <div class="collage" id="flickr_collage_2">
    <div class="header">
      <form>
        <input type="text" name="q" class="q" value="Search flickr" /> 
        <input type="submit" value="Go!" class="fetch"/>
      </form>
    </div>
    <div class="photos"></div>
  </div>
  
<script src="prototype.s2.min.js" type="text/javascript"></script>

<script type="text/javascript">
  // Setup
  S2.enableMultitouchSupport = true;
  
  // App-wide variables
	var r = Math.random, z=1, overCollage = document,
	    subElement = function(sel) {
	    	return function(self) { return Selector.findChildElements(this.el, [sel])[0]; };
	    },
	    subElements = function(sel) {
	    	return function(self) { return Selector.findChildElements(this.el, [sel]); };
	    },
	    
	    Collages = {
    	  collages: [],
    	  addCollage: function(c){
    	    this.collages.push(c);
    	  },
    	  overCollage: function(e){
    	    return this.collages.find(function(c){
    	      var eOffset = e.cumulativeOffset(), x = eOffset[0], y = eOffset[1],
    	          cOffset = c.el.cumulativeOffset(), top = cOffset[0], left = cOffset[1],
    	          bottom = top + c.el.getHeight(), right = left+c.el.getWidth();
    	      console.log(c.el.id, top, y, bottom, "|", left, x, right);
    	      return y > top < bottom && x > left < right;
  	      });
    	  }
    	};
	    
	    
	// Collage classes
  FlickrCollage = Class.create({
	  inputE:  subElement(".q"),
	  fetchE:  subElement(".fetch"),
	  photoE:  subElement(".photos"),
		imageEs: subElements(".photos img"),
		headerE: subElement(".header"),
		clearE:  subElement(".clear"),
		infoE:   subElement(".info"), 
		formE:   subElement("form"),
		initialize: function(el) {
		  this.el = el;
	    this.fetchE().observe("click", (function(){this.fetchPictures();}).bind(this));
	    this.inputE().observe("click", (function(){this.inputE().focus();}).bind(this));
	    this.formE().observe("submit", (function(e){e.stop();this.el.fire("collage:fetch");}).bind(this));
	    this.el.observe("collage:fetch", (function(e){e.stop();this.fetchPictures();}).bind(this));
	    Collages.addCollage(this);
		},
	  fetchPictures: function(){
      var that = this, url = 'http://api.flickr.com/services/feeds/photos_public.gne?format=json&tags='+
                encodeURIComponent(this.inputE().getValue())+
                '&tags_mode=ANY&nojsoncallback=1';
      new Ajax.Request(url, { method:'get',
        onSuccess: function(response) { that.processData(response.responseText.evalJSON()); }
      });
	  },
	  processData: function(data) {
	    var that = this;
      data.items.each(function(photo,idx){
        if(idx>10) return;
        var image = that.newImage(photo),
            pos = [r()*that.el.getHeight(), r()*that.el.getWidth(), r()*1-0.5, photo];
        image.store("pos", pos);
        image.alt = "'" + photo.title + "' by " + photo.author;
        that.photoE().insert(image);
        that.addImageEvents(image);
        
        image.style.cssText += 'left:0px;top:-500px;z-index:'+(z++);
        image.transform({ rotation: pos[2] });
        image.morph(
          'left:'+pos[0]+'px;'+
          'top:'+pos[1]+'px',{
            duration:0.2+r()*1.5,delay:idx*0.2
        });
      });
	  },
		newImage: function(photo) {
		  var image = new Element('img', { src: photo.media.m }), 
		      x = r()*500-50, y = -200, z=0, t=0;
        // deserialize: x=photo.x, y=photo.y, z=photo.z, t=photo["-webkit-transform"], pos=[x,y]; // FIXME
      image.style.cssText += ";top:"+y+";left:"+x+";z-index:"+ z++ +";-webkit-transform:"+t;
      return image;
		},
		insertImage: function(img) {
      this.photoE().insert(image);
		},
		deserialize: function(data) {
      data.images.each(function(img) {
        this.insertImage(self.newImage(img));
      });
    },
	  addImageEvents: function(img) {
	    var that = this;
	    img.observe('manipulate:update', function(event){
	      pos = img.retrieve("pos");
        img.style.cssText += 
          ';z-index:'+(z++)+';left:'+(pos[0]+event.memo.panX)+'px;top:'+(pos[1]+event.memo.panY)+'px;';
        img.transform({ rotation: pos[2]+event.memo.rotation, scale: event.memo.scale });
        img._x = pos[0]+event.memo.panX;
        img._y = pos[1]+event.memo.panY;
        img._r = pos[2]+event.memo.rotation;
        img._scale = event.memo.scale
      
	      if(event.memo.scale < 0.4) { img.remove(); return; }
        event.stop();
      });
      
	    img.observe("mousedown", function(e){ this.el.insert(e.element())}.bind(this));
	    img.observe("mouseup", function(e){ Collages.overCollage(e.element()); });
	  }
	});
	
	// Initialize collages
	
	document.observe("dom:loaded", function(){
	  fc  = new FlickrCollage($("flickr_collage"));
  	fc2 = new FlickrCollage($("flickr_collage_2"));
	});
</script>
</body>
</html>